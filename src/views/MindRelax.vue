<!-- å¿ƒçµèˆ’ç¼“é¦† -->
<template>
  <div class="mind-relax-page">
    <!-- å¯¼èˆªå¤´éƒ¨ - ä½¿ç”¨ç°æœ‰çš„ NavHeader ç»„ä»¶ -->
    <NavHeader />

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
      <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
      <section class="page-header-section">
        <h1 class="main-title">å¿ƒçµèˆ’ç¼“é¦†</h1>
        <p class="subtitle">é€šè¿‡æ¸¸æˆã€éŸ³ä¹ã€æ•…äº‹å¤šå…ƒåŒ–æ–¹å¼ï¼Œå¸®æ‚¨é‡Šæ”¾å‹åŠ›ã€å¹³å¤æƒ…ç»ª</p>
      </section>

      <!-- æ ¸å¿ƒåŠŸèƒ½æ¨¡å—åŒºåŸŸ -->
      <section class="relax-modules-section">
        <div class="modules-grid">
          <!-- æ¸¸æˆèˆ’ç¼“æ¨¡å— -->
          <div class="module-card game-module">
            <div class="module-icon game-icon">ğŸ®</div>
            <h2 class="module-title">è½»æ¾æ¸¸æˆ</h2>
            <p class="module-description">
              ç®€å•æœ‰è¶£çš„å°æ¸¸æˆï¼Œè®©æ‚¨åœ¨è½»æ¾æ„‰å¿«çš„æ°›å›´ä¸­è½¬ç§»æ³¨æ„åŠ›ï¼Œç¼“è§£å‹åŠ›
            </p>
            <div class="game-list">
              <div class="game-item">
                <span class="game-emoji">ğŸ</span>
                <span class="game-name">æ‰‹åŠ¿è´ªåƒè›‡</span>
              </div>
              <div class="game-item">
                <span class="game-emoji">ğŸ§©</span>
                <span class="game-name">ä¿„ç½—æ–¯æ–¹å—</span>
              </div>
              <div class="game-item">
                <span class="game-emoji">ğŸ“¦</span>
                <span class="game-name">æ¨ç®±å­æ¸¸æˆ</span>
              </div>
            </div>
            <button class="action-btn" @click="showAllGames">æŸ¥çœ‹å…¨éƒ¨æ¸¸æˆ â†’</button>
          </div>

          <!-- éŸ³ä¹èˆ’ç¼“æ¨¡å— -->
          <div class="module-card music-module">
            <div class="module-icon music-icon">ğŸµ</div>
            <h2 class="module-title">é™å¿ƒéŸ³ä¹</h2>
            <p class="module-description">
              ç²¾é€‰èˆ’ç¼“éŸ³ä¹ï¼Œå¸®åŠ©æ‚¨æ”¾æ¾èº«å¿ƒï¼Œè°ƒæ•´æƒ…ç»ªçŠ¶æ€
            </p>
            <!-- æ›¿æ¢åŸæœ‰çš„éŸ³ä¹æ’­æ”¾å™¨æ¨¡æ¿ -->
            <div class="music-player">
              <div class="music-album">
                <div class="album-cover">
                  <span class="album-emoji">ğŸµ</span>
                </div>
                <div class="music-info">
                  <h3 class="music-title">{{ playerTitle }}</h3>
                  <p class="music-artist">{{ playerAuthor }}</p>
                </div>
              </div>
              <div class="music-controls">
                <button class="control-btn" @click="previousTrack">â®ï¸</button>
                <button class="control-btn" @click="togglePlay">{{ isPlaying ? 'â¸ï¸' : 'â–¶ï¸' }}</button>
                <button class="control-btn" @click="nextTrack">â­ï¸</button>
              </div>
              <div class="music-progress">
                <div class="progress-bar">
                  <div class="progress-fill" :style="{ width: progress + '%' }"></div>
                </div>
                <div class="time-info">{{ formatTime(currentTime) }} / {{ formatTime(duration) }}</div>
              </div>
            </div>
            <button class="action-btn" @click="showAllMusic">æµè§ˆéŸ³ä¹åº“ â†’</button>
          </div>

          <!-- æ•…äº‹èˆ’ç¼“æ¨¡å— -->
          <div class="module-card story-module">
            <div class="module-icon story-icon">ğŸ“–</div>
            <h2 class="module-title">æš–å¿ƒæ•…äº‹</h2>
            <p class="module-description">
              æ¸©é¦¨æ²»æ„ˆçš„å°æ•…äº‹ï¼Œå¸¦ç»™æ‚¨å¿ƒçµçš„æ…°è—‰å’Œå¯å‘
            </p>
            <div class="story-list">
              <div class="story-item">
                <div class="story-content">
                  <h3 class="story-title">æ£®æ—ä¹‹æ—…</h3>
                  <p class="story-excerpt">åœ¨ä¸€ç‰‡å®é™çš„æ£®æ—é‡Œï¼Œå°å…”å­å¼€å§‹äº†ä¸€æ®µå¥‡å¦™çš„æ—…ç¨‹...</p>
                </div>
                <span class="story-time">5åˆ†é’Ÿ</span>
              </div>
              <div class="story-item">
                <div class="story-content">
                  <h3 class="story-title">æ˜Ÿç©ºå¤œè¯</h3>
                  <p class="story-excerpt">å½“å¤œå¹•é™ä¸´ï¼Œæ˜Ÿæ˜Ÿä»¬å¼€å§‹è®²è¿°å®ƒä»¬çš„æ•…äº‹...</p>
                </div>
                <span class="story-time">8åˆ†é’Ÿ</span>
              </div>
            </div>
            <button class="action-btn" @click="showAllStories">æŸ¥çœ‹æ›´å¤šæ•…äº‹ â†’</button>
          </div>
        </div>
      </section>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'
import { API_URLS } from '@/config/api.js'
import NavHeader from '../components/NavHeader.vue'
import router from '@/router'

// æ·»åŠ ç™»å½•æ£€æµ‹å‡½æ•°
const getToken = () => {
  return localStorage.getItem('token')
}

const getUserId = () => {
  const userInfoStr = localStorage.getItem('userInfo')
  if (userInfoStr) {
    try {
      const userInfo = JSON.parse(userInfoStr)
      return userInfo.id || null
    } catch (e) {
      console.warn('userInfo è§£æå¤±è´¥')
      return null
    }
  }
  return null
}


// åˆ›å»ºaxioså®ä¾‹
const axiosInstance = axios.create({
  baseURL: API_URLS.SOUL_ASSESS,
  timeout: 10000
})

const isPlaying = ref(false)
const progress = ref(0)
const currentTime = ref(0)
const duration = ref(0)
const playerTitle = ref('è¯·é€‰æ‹©ä¸€ä¸ªéŸ³é¢‘')
const playerAuthor = ref('')
const items = ref([]) // éŸ³ä¹åˆ—è¡¨
const currentIndex = ref(0) // å½“å‰æ’­æ”¾ç´¢å¼•
const audioPlayer = ref(null) // éšå½¢audioå…ƒç´ 

// // æ¸¸æˆåŠŸèƒ½
// const startGame = (gameType) => {
//   // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
//   const token = getToken()
//   const userId = getUserId()
//   if (!userId || !token) {
//     alert('è¯·å…ˆç™»å½•åå†ç©æ¸¸æˆ')
//     return
//   }

//   console.log(`å¼€å§‹æ¸¸æˆ: ${gameType}`)
//   // alert(`å‡†å¤‡å¼€å§‹${gameType === 'relaxPuzzle' ? 'æ‰‹åŠ¿è´ªåƒè›‡' : gameType === 'breathingExercise' ? 'ç²’å­åŠ¨æ•ˆ' : 'æ¨ç®±å­æ¸¸æˆ'}æ¸¸æˆ`)
//   if (gameType === 'relaxPuzzle') {
//     router.push({ name: 'SnakeGame' })
//   } else if (gameType === 'breathingExercise') {
//     router.push({ name: 'ParticleEffect' })
//   } else if (gameType === 'sokoban') {
//     router.push({ name: 'Sokoban' })
//   }
// }

const showAllGames = () => {
  const token = getToken()
  const userId = getUserId()
  if (!userId || !token) {
    alert('è¯·å…ˆç™»å½•åæŸ¥çœ‹æ‰€æœ‰æ¸¸æˆ')
    return
  }

  console.log('æŸ¥çœ‹å…¨éƒ¨æ¸¸æˆ')
  router.push({ name: 'MindRelaxGame' })
}

// åŠ è½½éŸ³ä¹åˆ—è¡¨
const loadMusicList = async () => {
  try {
    const response = await axiosInstance.get('/music/findPage', {
      params: { pageNum: 1, pageSize: 5 }
    })

    if (response.data.code === 200) {
      items.value = response.data.data.list || []
      if (items.value.length > 0) {
        // é»˜è®¤è®¾ç½®ç¬¬ä¸€ä¸ªä¸ºå½“å‰æ’­æ”¾
        updateCurrentTrack(0)
      }
    }
  } catch (error) {
    console.error('åŠ è½½éŸ³ä¹åˆ—è¡¨å¤±è´¥:', error)
  }
}

// æ›´æ–°å½“å‰æ’­æ”¾æ›²ç›®
const updateCurrentTrack = (index) => {
  if (index >= 0 && index < items.value.length) {
    currentIndex.value = index
    const item = items.value[index]
    playerTitle.value = item.musicName
    playerAuthor.value = item.singer
  }
}

// æ’­æ”¾éŸ³é¢‘
const playAudio = async (index) => {
  if (index >= 0 && index < items.value.length) {
    updateCurrentTrack(index)

    const item = items.value[index]
    const id = item.musicId

    // å¢åŠ æ’­æ”¾æ¬¡æ•°
    try {
      await axiosInstance.post(`/music/play/${id}`)
    } catch (error) {
      console.warn('æ›´æ–°æ’­æ”¾æ¬¡æ•°å¤±è´¥:', error)
    }

    // è·å–éŸ³é¢‘æµURL
    const streamUrl = `${API_URLS.SOUL_ASSESS}/audio/music/${id}`

    // åˆ›å»ºä¸´æ—¶audioå…ƒç´ è¿›è¡Œæ’­æ”¾
    if (!audioPlayer.value) {
      audioPlayer.value = new Audio()
      audioPlayer.value.addEventListener('timeupdate', updateProgress)
      audioPlayer.value.addEventListener('ended', nextTrack)
      audioPlayer.value.addEventListener('loadedmetadata', () => {
        duration.value = audioPlayer.value.duration
      })
    }

    audioPlayer.value.src = streamUrl
    audioPlayer.value.load()

    setTimeout(async () => {
      try {
        await audioPlayer.value.play()
        isPlaying.value = true
      } catch (error) {
        console.error('æ’­æ”¾å¤±è´¥:', error)
        isPlaying.value = false
      }
    }, 500)
  }
}

// åˆ‡æ¢æ’­æ”¾/æš‚åœ
const togglePlay = async () => {
  if (items.value.length === 0) {
    await loadMusicList()
    if (items.value.length > 0) {
      await playAudio(0)
      return
    }
  }

  if (!audioPlayer.value) return

  if (isPlaying.value) {
    audioPlayer.value.pause()
  } else {
    await audioPlayer.value.play()
  }
  isPlaying.value = !isPlaying.value
}

// ä¸Šä¸€é¦–
const previousTrack = () => {
  if (items.value.length === 0) return

  const newIndex = (currentIndex.value - 1 + items.value.length) % items.value.length
  playAudio(newIndex)
}

// ä¸‹ä¸€é¦–
const nextTrack = () => {
  if (items.value.length === 0) return

  const newIndex = (currentIndex.value + 1) % items.value.length
  playAudio(newIndex)
}

// æ›´æ–°æ’­æ”¾è¿›åº¦
const updateProgress = () => {
  if (audioPlayer.value) {
    currentTime.value = audioPlayer.value.currentTime
    duration.value = audioPlayer.value.duration || 0
    progress.value = duration.value ? (currentTime.value / duration.value) * 100 : 0
  }
}

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (seconds) => {
  if (isNaN(seconds)) return '0:00'
  const mins = Math.floor(seconds / 60)
  const secs = Math.floor(seconds % 60)
  return `${mins}:${secs < 10 ? '0' : ''}${secs}`
}

// åœ¨ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½éŸ³ä¹åˆ—è¡¨
onMounted(() => {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
  const token = getToken()
  const userId = getUserId()
  if (!userId || !token) {
    alert('è¯·å…ˆç™»å½•åå†è®¿é—®æ­¤é¡µé¢')
    // å¯ä»¥é€‰æ‹©é‡å®šå‘åˆ°ç™»å½•é¡µé¢
    // router.push('/login')
  }

  loadMusicList()
})

const showAllMusic = () => {
  const token = getToken()
  const userId = getUserId()
  if (!userId || !token) {
    alert('è¯·å…ˆç™»å½•åæµè§ˆéŸ³ä¹åº“')
    return
  }

  console.log('æµè§ˆéŸ³ä¹åº“')
  router.push({ name: 'MindRelaxMusic' })
}

const showAllStories = () => {
  const token = getToken()
  const userId = getUserId()
  if (!userId || !token) {
    alert('è¯·å…ˆç™»å½•åæŸ¥çœ‹æ‰€æœ‰æ•…äº‹')
    return
  }

  console.log('æŸ¥çœ‹æ›´å¤šæ•…äº‹')
  router.push({ name: 'MindRelaxStory' })
}
</script>

<style scoped>
/* é¡µé¢åŸºç¡€æ ·å¼ */
.mind-relax-page {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px 20px;
}

/* é¡µé¢æ ‡é¢˜åŒºåŸŸ */
.page-header-section {
  text-align: center;
  margin-bottom: 48px;
  color: white;
}

.main-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 16px;
  text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.subtitle {
  font-size: 1.125rem;
  opacity: 0.9;
  max-width: 600px;
  margin: 0 auto;
}

/* æ ¸å¿ƒåŠŸèƒ½æ¨¡å—åŒºåŸŸ */
.relax-modules-section {
  margin-bottom: 64px;
}

.modules-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 32px;
}

.module-card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 32px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  backdrop-filter: blur(10px);
}

.module-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
}

.module-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}

.module-title {
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 12px;
  color: #333;
}

.module-description {
  font-size: 1rem;
  color: #666;
  margin-bottom: 24px;
  line-height: 1.6;
}

/* æ¸¸æˆæ¨¡å—æ ·å¼ */
.game-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}

.game-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: #f8f9fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.game-item:hover {
  background: #e9ecef;
  transform: translateX(5px);
}

.game-emoji {
  font-size: 1.5rem;
  margin-right: 12px;
}

.game-name {
  font-weight: 500;
  color: #495057;
}

/* éŸ³ä¹æ¨¡å—æ ·å¼ */
.music-player {
  background: #f8f9fa;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.music-album {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
}

.album-cover {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 16px;
}

.album-emoji {
  font-size: 2rem;
}

.music-info {
  flex: 1;
}

.music-title {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: #333;
}

.music-artist {
  font-size: 0.875rem;
  color: #666;
}

.music-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.control-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: #667eea;
  color: white;
  border-radius: 50%;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.control-btn:hover {
  background: #5a6fd8;
  transform: scale(1.1);
}

.music-progress {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.progress-bar {
  height: 6px;
  background: #e9ecef;
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
  transition: width 0.3s ease;
}

.time-info {
  font-size: 0.75rem;
  color: #666;
  text-align: right;
}

/* æ•…äº‹æ¨¡å—æ ·å¼ */
.story-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 24px;
}

.story-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.story-item:hover {
  background: #e9ecef;
}

.story-content {
  flex: 1;
}

.story-title {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: #333;
}

.story-excerpt {
  font-size: 0.875rem;
  color: #666;
  line-height: 1.5;
}

.story-time {
  font-size: 0.75rem;
  color: #999;
  background: #dee2e6;
  padding: 4px 8px;
  border-radius: 12px;
  align-self: center;
}

/* æŒ‰é’®æ ·å¼ */
.action-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* å¿«é€Ÿå…¥å£åŒºåŸŸ */
.quick-access-section {
  text-align: center;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 24px;
  color: white;
}

.quick-actions {
  display: flex;
  justify-content: center;
  gap: 24px;
  flex-wrap: wrap;
}

.quick-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.9);
  border: none;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 120px;
  backdrop-filter: blur(10px);
}

.quick-btn:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.quick-emoji {
  font-size: 2rem;
}

.quick-text {
  font-weight: 500;
  color: #495057;
  font-size: 0.875rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .modules-grid {
    grid-template-columns: 1fr;
  }
  
  .main-title {
    font-size: 2rem;
  }
  
  .module-card {
    padding: 24px;
  }
  
  .quick-actions {
    flex-direction: column;
    align-items: center;
  }
  
  .quick-btn {
    width: 200px;
  }
}
</style>